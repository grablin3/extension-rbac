from rest_framework.permissions import BasePermission
from .models import UserRole


class IsRoot(BasePermission):
    """
    Allows access only to root users.
    """
    message = "Root access required."

    def has_permission(self, request, view):
        if not request.user or not request.user.is_authenticated:
            return False
        return request.user.is_root()


class IsAdmin(BasePermission):
    """
    Allows access only to admin users (including root).
    """
    message = "Admin access required."

    def has_permission(self, request, view):
        if not request.user or not request.user.is_authenticated:
            return False
        return request.user.is_admin()


class IsAdminOrReadOnly(BasePermission):
    """
    Allows full access to admin users, read-only for others.
    """
    message = "Admin access required for write operations."

    def has_permission(self, request, view):
        if request.method in ('GET', 'HEAD', 'OPTIONS'):
            return True
        if not request.user or not request.user.is_authenticated:
            return False
        return request.user.is_admin()


class HasRole(BasePermission):
    """
    Allows access only to users with specific roles.

    Usage:
        class MyView(APIView):
            permission_classes = [HasRole]
            required_roles = ['admin', 'manager']
    """
    message = "You do not have the required role."

    def has_permission(self, request, view):
        if not request.user or not request.user.is_authenticated:
            return False

        required_roles = getattr(view, 'required_roles', [])
        if not required_roles:
            return True

        return any(request.user.has_role(role) for role in required_roles)


class IsOwnerOrAdmin(BasePermission):
    """
    Object-level permission to only allow owners of an object or admins to access it.

    Assumes the model instance has an `owner` attribute or `user` attribute.
    """
    message = "You must be the owner or an admin."

    def has_object_permission(self, request, view, obj):
        if not request.user or not request.user.is_authenticated:
            return False

        # Admins have full access
        if request.user.is_admin():
            return True

        # Check if user owns the object
        owner = getattr(obj, 'owner', None) or getattr(obj, 'user', None)
        if owner:
            return owner.id == request.user.id

        return False
